(window.dullscriptWebpackJsonp=window.dullscriptWebpackJsonp||[]).push([[38],{1380:function(D,F,b){function a(Y){var L=fa.call(this)||this;L.$=Y;L.fc();return L}function d(Y){switch(Y){case 1:return"Edit";case 2:return"View";case 3:return"InstantView";default:return"Unknown"}}function c(Y){switch(Y){case 3:return"Word";case 2:return"PowerPoint";case 1:return"Excel";default:return"Unknown"}}function m(Y,L,P,ea,X,ja){var R=this;ea=void 0===ea?!1:ea;X=void 0===X?null:X;ja=void 0===ja?null:ja;this.aCa=
this.$Ba=0;this.Svb=this.aPb=!1;this.rpa=null;this.sgb=!0;this.ySb=null;v.ULS.sendTraceTag(26019598,378,100,"Initializing SafeLinksManager.");this.yb=Y;this.Ug=L;this.QMb=P;m.rh=ja;this.jmg=ea?this.yb.Wa("SafeLinksHandlerWebServiceBase"):this.yb.Wa("WebServiceBase");this.Tlg=this.yb.Wa("SafeLinksHashedUserId");this.VCj=this.yb.Wa("SafeLinksWorkloadIdHeaderValue");this.rQb=this.yb.qd("SafeLinksMaxGetPolicyBootRetries",2);this.sQb=this.yb.qd("SafeLinksMaxGetPolicyOnLinkClickRetries",1);this.BPb=this.isSafeLinksEnabledForUser();
this.APb=this.D5h();v.ULS.sendTraceTag(26019599,378,50,"SafeLinksManager _isEnabledForUser={0}, _isEnabledForBrowser={1}",this.BPb,this.APb);if(this.BPb&&this.APb){Y=(L=this.I0a())?L.IsSafeLinksEnabled.toLowerCase():"";P=this.ejd();v.ULS.sendTraceTag(36231312,378,50,"Cached values for IsSafeLinksEnabled: {0}, IsPolicyCookieExpired: {1}.",Y,P);var ba=!L||"unknown"===Y||L.WasServiceDown||P;if(L=this.xs())L.set("shouldGetSafeLinksDataFromServer",ba.toString()),L.set("isSafeLinksEnabledCacheValue",Y.toString());
J.Health.instance.recordKpiUsage("SafeLinksGetPolicy1",0,"jpittsdirects",L);this.yb.xy("LicensingForSafeLinksIsEnabled")&&this.yb.ta("LicensingForSafeLinksIsEnabled")&&X?(this.sgb=!1,X.execute(function(ha){ha.isFeatureEnabled("MsoUrlreputation",!0).then(function(oa){R.sgb=oa;R.sgb&&ba&&R.I8b(!0);return null})})):ba&&this.I8b(!0)}}function r(Y,L,P,ea){this.yb=Y;this.Ug=L;this.fdg=P;r.rh=ea}function t(Y,L){this.Vtc=Y;this.stopwatch=L}function k(Y,L,P,ea,X,ja){this.PolicyCookie=this.WebAffinitizedUrl=
this.IsSafeLinksEnabled=null;this.PolicyCookieTTL=0;this.WasServiceDown=!1;this.AffinitizedUrl=null;this.IsSafeLinksEnabled=Y;this.WebAffinitizedUrl=L;this.PolicyCookie=P;this.PolicyCookieTTL=ea;this.WasServiceDown=X;this.AffinitizedUrl=ja}b.r(F);var u=b(12);D=b(0);var w=b(5);F=b(211);var v=b(15),A=b(37);Object(D.a)(k,"SafeLinksData",null,[]);Object(D.a)(t,"SafeLinksGetUrlReputationRequestData",null,[]);var y=b(41),x=b(49);r.prototype.Tza=function(Y,L,P){try{var ea=null;r.rh&&(ea=r.rh.Ic("WebServiceCall",
"SafeLinksGetUrlReputation"));var X=new t(L,ea);ea={};ea.AffinitizedUrl=Y;ea.TargetUrl=L;ea.PolicyCookie=P;var ja=y.c(ea);this.Ug.Wl(this.fdg,2,ja,null,!1,2,Object(A.a)(this,this.Qti,"onGetUrlReputationSuccessCallback"),Object(A.a)(this,this.Pti,"onGetUrlReputationFailureCallback"),X,void 0,void 0,3E3,3E3,"36");return!0}catch(R){v.ULS.sendTraceTag(588788033,378,10,R.message)}return!1};r.prototype.Qti=function(Y){var L="OnGetUrlReputationSuccessCallback: ",P=10,ea=Y.data.state;try{var X=y.b(Y.data.pe).reputationResults[0],
ja=X.navigateUrl.length,R=ea.Vtc.length,ba=X.navigateUrl===ea.Vtc;X.navigateUrl&&0<X.navigateUrl.length&&(ea.Vtc=X.navigateUrl);L+=String.format("HttpStatus {0}, verdict {1}, clickedUrlLength = {2} navigateUrlLength {3}, navigateUrlSameAsClickedUrl {4}",Y.data.httpStatus,X.verdict,R.toString(),ja.toString(),ba.toString());P=50}catch(ha){L+=String.format("Exception {0}",ha.message)}this.KXe(ea,L,P)};r.prototype.Pti=function(Y){var L="OnGetUrlReputationFailureCallback: ",P=Y.data.state;try{L+=String.format("HttpStatus {0}",
Y.data.httpStatus)}catch(ea){L+=String.format("Exception {0}",ea.message)}this.KXe(P,L,10)};r.prototype.KXe=function(Y,L,P){Y.stopwatch&&(Y.stopwatch.stop(),Y.stopwatch=null);v.ULS.sendTraceTag(588788034,378,P,L);x.a.wf(Y.Vtc,void 0,"noopener,noreferrer","SafeLinksNav")};r.rh=null;Object(D.a)(r,"SafeLinksNavigationHelper",null,[]);var z;(function(Y){Y[Y.enabledByPolicy=0]="enabledByPolicy";Y[Y.disabledByPolicy=1]="disabledByPolicy";Y[Y.disabled_GetPolicyFailure=2]="disabled_GetPolicyFailure";Y[Y.disabled_PendingGetPolicyRequest=
3]="disabled_PendingGetPolicyRequest"})(z||(z={}));Object(D.b)("SafeLinksNavigationState",z);var J=b(93),B=b(935),C=b(277),H=b(228),W=b(789),S=b(24),N=b(194),T=b(176);m.prototype.Tza=function(Y){if(!Y)return v.ULS.sendTraceTag(593367827,378,10,"SafeLinksManager.TryNavigate: Null/Empty targetUrl"),!1;var L=this.t2h(Y);v.ULS.sendTraceTag(594830615,378,50,"SafeLinksManager.TryNavigate: isSupportedHyperLinkType={0},_isEnabledForUser={1},_isEnabledForBrowser={2},_isUserLicensedForSafeLinks={3}",L,this.BPb,
this.APb,this.sgb);if(!(L&&this.BPb&&this.APb&&this.sgb))return!1;var P=this.Fej();L=P.state;P=P.returnValue;v.ULS.sendTraceTag(595079385,378,50,"ShouldTryUsingSafeLinksService returned NavigationState={0}",z[L]);var ea=this.xs();ea&&ea.set("SafeLinksNavigationState",z[L]);J.Health.instance.recordKpiUsage("SafeLinksNavigations",0,"jpittsdirects",ea);if(!P)return 2!==L&&3!==L||J.Health.instance.recordKpiFailure("SafeLinksNavigations",z[L],!1,!0,null),!1;v.ULS.sendTraceTag(26019601,378,50,"Using safelinks to navigate hyperlink");
if(this.Mej())return this.ejd()?!1:this.Zji.Tza(this.hth(),Y,this.oTe());if(!this.ejd())return this.i0f(Y),!0;this.rpa=Y;v.ULS.sendTraceTag(24462627,378,50,"Refreshing the cache as policy cookie expired.");this.Svb=!1;this.I8b();return!0};m.prototype.t2h=function(Y){Y=Y.toLowerCase();var L=this.yb.zx("SafeLinksUnsupportedProtocols");if(L)for(var P=0;P<L.length;P++)if(Y.startsWith(L[P]))return!1;return!0};m.prototype.I8b=function(Y){Y=void 0===Y?!1:Y;var L=this.xs();L&&L.set("isOnBootRequest",Y.toString());
J.Health.instance.recordKpiUsage("SafeLinksGetPolicySuccessfulRequest",1,"jpittsdirects",L);J.Health.instance.recordKpiUsage("SafeLinksGetPolicyFailedRequest",0,"jpittsdirects",L);L=this.EYc("SafeLinksGetPolicy");this.Ug.Wl(this.REh,1,null,null,!0,2,Object(A.a)(this,this.$Gh,"getSafeLinksDataFromServer_OnSuccessCallback"),Object(A.a)(this,this.ZGh,"getSafeLinksDataFromServer_OnFailureCallback"),L,void 0,void 0,void 0,void 0,"23");this.Svb=Y;this.aPb=!0;Y?this.$Ba++:this.aCa++};m.prototype.$Gh=function(Y){var L=
H.a.ali,P="";try{this.aPb=this.Svb=!1;var ea=this.ltc(Y.data.state).returnValue,X=Object.assign(new T.a,{durationMs:ea});J.Health.instance.recordKpiSuccess("SafeLinksGetPolicySuccessfulRequest",X);v.ULS.sendTraceTag(594830614,378,50,"GetSafeLinksDataFromServer_OnSuccessCallback: HttpStatus {0}, data length {1}, Duration {2}",Y.data.httpStatus,Y.data.pe.length,ea);if(Y.data.httpStatus!==H.a.bO)P="Unexpected httpStatus: "+Y.data.httpStatus.toString();else{ea=null;try{ea=y.b(Y.data.pe)}catch(xa){P="Exception:"+
xa.toString()+" deserializing response";return}if(ea){var ja=ea.IsSafeLinksEnabled;if(void 0===ja||null===ja||0>=ja.length)P="Invalid isSafeLinksEnabledString";else{v.ULS.sendTraceTag(594830613,378,50,"Retrieved isSafeLinksEnabledString {0}",ja);var R=m.Lvd(ja);if(void 0===ea.WebAffinitizedUrl||null===ea.WebAffinitizedUrl||0>=ea.WebAffinitizedUrl.length)P="Invalid WebAffinitizedUrl";else if(void 0===ea.PolicyCookie||null===ea.PolicyCookie||0>=ea.PolicyCookie.length)P="Invalid PolicyCookie";else if(void 0===
ea.PolicyCookieTTL||null===ea.PolicyCookieTTL)P="Invalid PolicyCookieTTL";else{var ba=ea.WebAffinitizedUrl,ha=ea.PolicyCookie,oa=ea.AffinitizedUrl,Sa=new Date;Sa.setMinutes(Sa.getMinutes()+(5<ea.PolicyCookieTTL?ea.PolicyCookieTTL-5:0));var ma=Sa.getTime(),na=new k(ja,ba,ha,ma,!1,oa);this.rNf(na);L=Y.data.httpStatus;this.rpa&&(R?(this.i0f(this.rpa),this.aCa=this.$Ba=0):(v.ULS.sendTraceTag(26019602,378,50,"SafeLinks is disabled by admin; Navigating without SafeLinks"),J.Health.instance.recordKpiFailure("SafeLinksNavigations",
"disabledByPolicy",!0,!0,null),x.a.PY(this.rpa)),this.rpa=null)}}}else P="Error when serializing response into SafeLinksData. SafeLinksData is null."}}catch(xa){P="GetSafeLinksDataFromServer_OnSuccessCallback: Exception:  "+xa.toString()}finally{L!==H.a.bO&&this.JXe(L,P)}};m.prototype.ZGh=function(Y){this.aPb=!1;var L=500,P="";try{var ea=this.ltc(Y.data.state).returnValue,X=Object.assign(new T.a,{durationMs:ea});L=Y.data.httpStatus;J.Health.instance.recordKpiFailure("SafeLinksGetPolicyFailedRequest",
"HttpStatusCode_"+L.toString(),!1,!0,X);P="Request Failed, Status="+W.a[Y.data.status]+" Duration: "+ea}catch(ja){P="GetSafeLinksDataFromServer_OnFailureCallback Exception: "+ja.toString()}finally{this.JXe(L,P)}};m.prototype.JXe=function(Y,L){L=void 0===L?"":L;try{if(v.ULS.sendTraceTag(594830612,378,10,"HandleGetPolicyRequestError: HttpStatus {0}, Error {1}",Y,L),this.$Ba<this.rQb&&this.aCa<this.sQb)this.I8b(this.Svb);else{this.Svb=!1;v.ULS.sendTraceTag(24462656,378,10,"Exhausted all retries for SafeLinks GetPolicy call. OnBootRetries: {0}, OnClickRetries: {1}, HttpStatus: {2}, Error: {3}",
this.$Ba,this.aCa,Y,L);L=null;var P=this.xs();P&&(P.set("HttpStatus",Y.toString()),L=Object.assign(new T.a,{extendedProperties:P}));J.Health.instance.recordKpiFailure("SafeLinksGetPolicy1","GetPolicyRequestError",!1,!0,L);var ea=new k("false","","",0,!0,"");this.rNf(ea);this.rpa&&(v.ULS.sendTraceTag(26019603,378,50,"Error occurred during at-click GetPolicy call, NavigationState = {0}","disabled_GetPolicyFailure"),J.Health.instance.recordKpiFailure("SafeLinksNavigations","disabled_GetPolicyFailure",
!1,!0,null),x.a.PY(this.rpa),this.rpa=null)}}catch(X){v.ULS.sendTraceTag(594830611,378,10,"HandleGetPolicyRequestError: Exception {0}",X.toString())}};m.prototype.i0f=function(Y){var L=this.oTe(),P=this.RKh(),ea={};ea.Url=Y;ea.SafeLinksCookie=L;ea.CorrelationId=N.a.create().toString();ea.WorkloadId=this.VCj;ea.UserAgentInfo=S.a.xXa+"|"+this.appName;v.ULS.sendTraceTag(23900187,378,50,"Validating hyperlink with request correlation: {0}",ea.CorrelationId);x.a.Qkc(x.a.JW(4),P,ea)};m.prototype.isSafeLinksEnabledForUser=
function(){var Y=this.yb.Wa("IsSafeLinksEnabledForUser");return Y?m.Lvd(Y):!1};m.prototype.D5h=function(){var Y=this.yb.zx("SafeLinksDisabledBrowsers");if(S.a.rA){if(this.yb.xy("SafeLinksForTeamsIsEnabled")&&this.yb.ta("SafeLinksForTeamsIsEnabled"))return!0;if(Array.contains(Y,"Electron"))return!1}else if(Array.contains(Y,S.a.xXa))return!1;return"officecomhwa"===(this.yb.Wa(w.AFrameworkApplication.$ma)||"").toLowerCase()?!1:!0};m.prototype.Mej=function(){return-1!==window.location.href.indexOf("&wd_slnh=1")?
!0:S.a.rA};m.prototype.Fej=function(){var Y=0;var L=this.I0a(),P=L?L.IsSafeLinksEnabled:"";if(""!==P)return L.WasServiceDown?(v.ULS.sendTraceTag(51663971,378,50,"Failed to retrieve policy data"),{returnValue:!1,state:2}):"false"===P.toLowerCase()?(v.ULS.sendTraceTag(51664E3,378,50,"SafeLinks disabled for the user"),{returnValue:!1,state:1}):{returnValue:m.Lvd(P),state:Y};if(this.aPb)return Y=3,v.ULS.sendTraceTag(595079384,378,50,"Currently getting SafeLinks policy"),{returnValue:!1,state:Y};if(this.$Ba>=
this.rQb||this.aCa>=this.sQb)return Y=2,v.ULS.sendTraceTag(51664001,378,50,"Exhausted all retries- Failure in GetPolicy for SafeLinks ({0}/{1} boot, {2}/{3} onClick)",this.$Ba,this.rQb,this.aCa,this.sQb),{returnValue:!1,state:Y};v.ULS.sendTraceTag(23900182,378,10,"Inconsistent SafeLinks state: SafeLinks cache data is null with no on boot request pending, and {0} retries left over. Perhaps LocalStorage is inaccessable.",this.rQb+this.sQb-(this.$Ba+this.aCa));return{returnValue:!0,state:Y}};m.prototype.oTe=
function(){var Y=this.I0a();return Y?Y.PolicyCookie:""};m.prototype.RKh=function(){var Y=this.I0a();return Y?Y.WebAffinitizedUrl:""};m.prototype.hth=function(){var Y=this.I0a();return Y?Y.AffinitizedUrl:""};m.prototype.Wyh=function(){var Y=new Date;try{var L=this.I0a();Y.setTime(L?L.PolicyCookieTTL:0)}catch(P){v.ULS.sendTraceTag(24462658,378,10,"Exception occured while fetching expiration time from cache: {0}",P)}return Y};m.prototype.ejd=function(){var Y=this.Wyh();return!!Y&&Y.getTime()<Date.now()};
m.prototype.I0a=function(){if(!this.ySb){var Y=B.a.instance.getItem(this.userId);if(!Y||""===Y)return null;this.ySb=JSON.parse(Y)}return this.ySb};m.prototype.rNf=function(Y){if(void 0===Y||null===Y)throw Error.argumentNull("safeLinksData");if(void 0===Y.IsSafeLinksEnabled||null===Y.IsSafeLinksEnabled||0>=Y.IsSafeLinksEnabled.length)throw Error.argumentNull("safeLinksData.IsSafeLinksEnabled");this.ySb=Y;Y.WasServiceDown||this.cDj(Y)};m.prototype.cDj=function(Y){Y=JSON.stringify(Y);B.a.instance.setItem(this.userId,
Y)};m.prototype.EYc=function(Y){return void 0!==m.rh&&null!==m.rh?m.rh.Ic("WebServiceCall",Y):null};m.prototype.ltc=function(Y){if(void 0!==Y&&null!==Y){var L=Y.Gc;Y.stop();return{returnValue:L,stopwatch:null}}return{returnValue:null,stopwatch:Y}};m.prototype.xs=function(){try{return new Map}catch(Y){return null}};m.Lvd=function(Y){return"false"!==Y.toLowerCase()?!0:!1};Jl.Object.defineProperties(m.prototype,{appName:{configurable:!0,enumerable:!0,get:function(){return this.QMb}},mxc:{configurable:!0,
enumerable:!0,get:function(){return this.jmg}},userId:{configurable:!0,enumerable:!0,get:function(){return this.Tlg}},REh:{configurable:!0,enumerable:!0,get:function(){var Y=this.mxc?this.mxc+"/":"",L=new C.QueryStringBuilder("SafeLinksHandler.ashx");L.Ym("app",this.appName);this.yb.ta("SafeLinksUseDebugHeader")&&L.Ym("action","debug");return String.format("{0}{1}&{2}",Y,L.toString(),w.AFrameworkApplication.hj)}},gKh:{configurable:!0,enumerable:!0,get:function(){var Y=this.mxc?this.mxc+"/":"",L=new C.QueryStringBuilder("SafeLinksHandler.ashx");
L.Ym("app",this.appName);this.yb.ta("SafeLinksUseDebugHeader")&&L.Ym("action","debug");L.Ym("slrt","GetUrlReputation");return String.format("{0}{1}&{2}",Y,L.toString(),w.AFrameworkApplication.hj)}},Zji:{configurable:!0,enumerable:!0,get:function(){m.wKc||(m.wKc=new r(this.yb,this.Ug,this.gKh,m.rh));return m.wKc}}});m.rh=null;m.wKc=null;Object(D.a)(m,"SafeLinksManager",null,[19]);var fa=F.a;Cm(a,fa);a.prototype.create=function(){this.Jb(this.$.ea.Ea(269,void 0)||new m(w.AFrameworkApplication.ha,w.AFrameworkApplication.Md,
String.format("{0}-{1}",c(w.AFrameworkApplication.za.Za.Xk),d(w.AFrameworkApplication.za.Za.qMa))))};a.la=function(Y){Y.ea.La(270,new a(Y))};Object(D.a)(a,"SafeLinksManagerFactory",F.a,[]);Type.registerNamespace("_Ewa");Type.registerNamespace("Common.App.SafeLinks");(function(){u.a.Ja(function(Y){a.la(Y)})})()}}]);

//# sourceMappingURL=EwaDS.safelinks.js.map